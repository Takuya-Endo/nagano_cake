<h1>ショッピングカート</h1>

<%= link_to "カートを空にする", '/cart_items/destroy_all', method: :delete, "data-confirm" => "カートを空にしますか？" %>

<table>
  <tr> <th>商品名</th> <th>単価(税込)</th> <th>数量</th> <th>小計</th> <th></th> </tr>

  <% total_price = 0 %>

  <% @cart_items.each do |cart_item| %>
    <% item = @items.find_by(id: cart_item.item_id) %>
      <tr>
        <td>
          <%= attachment_image_tag item, :image, :fill, 60, 60, format: 'jpg' 'png' %>
          <%= item.name %>
        </td>
        <td><%= (item.price * 1.1).round %></td>

        <td>
            <% @cart_item = cart_item %>
          <%= form_with model: @cart_item, url: cart_item_path(@cart_item.id), local: true do |f| %>
            <%= f.hidden_field :item_id %>
            <%= f.hidden_field :customer_id %>
            <%= f.number_field :amount %>
            <%#= cart_item.amount %>
            <%#= @cart_item = cart_item %>
            <%#= f.hidden_field :item_id, value: item.id %>
            <%#= f.number_field :amount, size: "1x1", min: 1, value: cart_item.amount %>
            <%= f.submit '変更' %>
          <% end %>
        </td>

        <td><%= (item.price * 1.1).round * cart_item.amount %></td>
        <td><%= link_to "削除する", "/cart_items/#{cart_item.id}", method: :delete, "data-confirm" => "この商品を削除しますか？" %></td>
      </tr>

      <% total_price += ((item.price * 1.1).round * cart_item.amount) %>

  <% end %>
</table>

<span>合計金額</span><%= total_price %>
<%= link_to "買い物を続ける", root_path %>
<%= link_to "情報入力に進む", '/orders/new' %>